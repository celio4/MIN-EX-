{"version":3,"sources":["../src/encryption.ts"],"sourcesContent":["/*\n * @boringnode/encryption\n *\n * @license MIT\n * @copyright Boring Node\n */\n\nimport { MessageVerifier } from './message_verifier.ts'\nimport type {\n  CypherText,\n  EncryptionConfig,\n  EncryptionDriverContract,\n  EncryptOptions,\n} from './types/main.ts'\n\n/**\n * Encryption class that wraps a driver and manages multiple keys.\n * Encrypts with the first key, decrypts by trying all keys.\n */\nexport class Encryption {\n  #drivers: EncryptionDriverContract[]\n  #verifier: MessageVerifier\n\n  constructor(config: EncryptionConfig) {\n    this.#drivers = config.keys.map((key) => config.driver(key))\n    this.#verifier = new MessageVerifier(config.keys)\n  }\n\n  /**\n   * Encrypt a value using the first key\n   */\n  encrypt(payload: any, options?: EncryptOptions): CypherText\n  encrypt(payload: any, expiresIn?: string | number, purpose?: string): CypherText\n  encrypt(\n    payload: any,\n    expiresInOrOptions?: string | number | EncryptOptions,\n    purpose?: string\n  ): CypherText {\n    let expiresIn: string | number | undefined\n    let actualPurpose: string | undefined\n\n    if (typeof expiresInOrOptions === 'object' && expiresInOrOptions !== null) {\n      expiresIn = expiresInOrOptions.expiresIn\n      actualPurpose = expiresInOrOptions.purpose\n    } else {\n      expiresIn = expiresInOrOptions\n      actualPurpose = purpose\n    }\n\n    return this.#drivers[0].encrypt(payload, expiresIn, actualPurpose)\n  }\n\n  /**\n   * Decrypt a value by trying all keys\n   */\n  decrypt<T extends any>(value: string, purpose?: string): T | null {\n    for (const driver of this.#drivers) {\n      const result = driver.decrypt<T>(value, purpose)\n      if (result !== null) {\n        return result\n      }\n    }\n    return null\n  }\n\n  blindIndex(payload: any, purpose: string): string {\n    return this.#drivers[0].blindIndex(payload, purpose)\n  }\n\n  blindIndexes(payload: any, purpose: string): string[] {\n    const indexes = new Set<string>()\n\n    for (const driver of this.#drivers) {\n      for (const index of driver.blindIndexes(payload, purpose)) {\n        indexes.add(index)\n      }\n    }\n\n    return [...indexes]\n  }\n\n  /**\n   * Get the message verifier instance\n   */\n  getMessageVerifier(): MessageVerifier {\n    return this.#verifier\n  }\n}\n"],"mappings":";;;;;AAmBO,IAAM,aAAN,MAAiB;AAAA,EACtB;AAAA,EACA;AAAA,EAEA,YAAY,QAA0B;AACpC,SAAK,WAAW,OAAO,KAAK,IAAI,CAAC,QAAQ,OAAO,OAAO,GAAG,CAAC;AAC3D,SAAK,YAAY,IAAI,gBAAgB,OAAO,IAAI;AAAA,EAClD;AAAA,EAOA,QACE,SACA,oBACA,SACY;AACZ,QAAI;AACJ,QAAI;AAEJ,QAAI,OAAO,uBAAuB,YAAY,uBAAuB,MAAM;AACzE,kBAAY,mBAAmB;AAC/B,sBAAgB,mBAAmB;AAAA,IACrC,OAAO;AACL,kBAAY;AACZ,sBAAgB;AAAA,IAClB;AAEA,WAAO,KAAK,SAAS,CAAC,EAAE,QAAQ,SAAS,WAAW,aAAa;AAAA,EACnE;AAAA;AAAA;AAAA;AAAA,EAKA,QAAuB,OAAe,SAA4B;AAChE,eAAW,UAAU,KAAK,UAAU;AAClC,YAAM,SAAS,OAAO,QAAW,OAAO,OAAO;AAC/C,UAAI,WAAW,MAAM;AACnB,eAAO;AAAA,MACT;AAAA,IACF;AACA,WAAO;AAAA,EACT;AAAA,EAEA,WAAW,SAAc,SAAyB;AAChD,WAAO,KAAK,SAAS,CAAC,EAAE,WAAW,SAAS,OAAO;AAAA,EACrD;AAAA,EAEA,aAAa,SAAc,SAA2B;AACpD,UAAM,UAAU,oBAAI,IAAY;AAEhC,eAAW,UAAU,KAAK,UAAU;AAClC,iBAAW,SAAS,OAAO,aAAa,SAAS,OAAO,GAAG;AACzD,gBAAQ,IAAI,KAAK;AAAA,MACnB;AAAA,IACF;AAEA,WAAO,CAAC,GAAG,OAAO;AAAA,EACpB;AAAA;AAAA;AAAA;AAAA,EAKA,qBAAsC;AACpC,WAAO,KAAK;AAAA,EACd;AACF;","names":[]}
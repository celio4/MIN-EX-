{"version":3,"sources":["../src/encryption_manager.ts","../src/debug.ts"],"sourcesContent":["/*\n * @boringnode/encryption\n *\n * @license MIT\n * @copyright Boring Node\n */\n\nimport { RuntimeException } from '@poppinss/utils/exception'\nimport debug from './debug.ts'\nimport { Encryption } from './encryption.ts'\nimport type { MessageVerifier } from './message_verifier.ts'\nimport type { CypherText, EncryptionConfig, EncryptOptions } from './types/main.ts'\n\nexport class EncryptionManager<KnownEncrypters extends Record<string, EncryptionConfig>> {\n  /**\n   * Encryption manager config with the\n   * list of encrypters in use.\n   */\n  readonly #config: {\n    default?: keyof KnownEncrypters\n    list: KnownEncrypters\n  }\n\n  /**\n   * Cache of encryption instances.\n   */\n  #encryptionCache: Partial<Record<keyof KnownEncrypters, Encryption>> = {}\n\n  constructor(config: { default?: keyof KnownEncrypters; list: KnownEncrypters }) {\n    this.#config = config\n\n    debug('creating encryption manager. config: %O', this.#config)\n  }\n\n  /**\n   * Use one of the registered encrypters to encrypt values.\n   *\n   * ```ts\n   * manager.use() // returns default encrypter\n   * manager.use('aes_256_cbc')\n   * ```\n   */\n  use<EncrypterName extends keyof KnownEncrypters>(encrypterName?: EncrypterName): Encryption {\n    let encrypterToUse: keyof KnownEncrypters | undefined = encrypterName || this.#config.default\n\n    if (!encrypterToUse) {\n      throw new RuntimeException(\n        'Cannot create encryption instance. No default encryption is defined in the config'\n      )\n    }\n\n    /**\n     * Use cached copy if exists\n     */\n    const cachedEncryption = this.#encryptionCache[encrypterToUse]\n    if (cachedEncryption) {\n      debug('using encrypter from cache. name: \"%s\"', encrypterToUse)\n      return cachedEncryption\n    }\n\n    const encrypterConfig = this.#config.list[encrypterToUse]\n\n    /**\n     * Create a new instance of Encryption class with the selected\n     * config and cache it\n     */\n    debug('creating encryption instance. name: \"%s\"', encrypterToUse)\n    const encryption = new Encryption(encrypterConfig)\n    this.#encryptionCache[encrypterToUse] = encryption\n\n    return encryption\n  }\n\n  getMessageVerifier(): MessageVerifier {\n    return this.use().getMessageVerifier()\n  }\n\n  encrypt(payload: any, options?: EncryptOptions): CypherText\n  encrypt(payload: any, expiresIn?: string | number, purpose?: string): CypherText\n  encrypt(\n    payload: any,\n    expiresInOrOptions?: string | number | EncryptOptions,\n    purpose?: string\n  ): CypherText {\n    let expiresIn: string | number | undefined\n    let actualPurpose: string | undefined\n\n    if (typeof expiresInOrOptions === 'object' && expiresInOrOptions !== null) {\n      expiresIn = expiresInOrOptions.expiresIn\n      actualPurpose = expiresInOrOptions.purpose\n    } else {\n      expiresIn = expiresInOrOptions\n      actualPurpose = purpose\n    }\n\n    return this.use().encrypt(payload, expiresIn, actualPurpose)\n  }\n\n  decrypt<T extends any>(value: string, purpose?: string): T | null {\n    return this.use().decrypt(value, purpose)\n  }\n\n  blindIndex(payload: any, purpose: string): string {\n    return this.use().blindIndex(payload, purpose)\n  }\n\n  blindIndexes(payload: any, purpose: string): string[] {\n    return this.use().blindIndexes(payload, purpose)\n  }\n}\n","/*\n * @boringnode/encryption\n *\n * @license MIT\n * @copyright Boring Node\n */\n\nimport { debuglog } from 'node:util'\n\nexport default debuglog('boringnode:encryption')\n"],"mappings":";;;;;;;;;;;;;;;;;;AAOA,SAAS,wBAAwB;;;ACAjC,SAAS,gBAAgB;AAEzB,IAAO,gBAAQ,SAAS,uBAAuB;;;ADIxC,IAAM,oBAAN,MAAkF;AAAA;AAAA;AAAA;AAAA;AAAA,EAK9E;AAAA;AAAA;AAAA;AAAA,EAQT,mBAAuE,CAAC;AAAA,EAExE,YAAY,QAAoE;AAC9E,SAAK,UAAU;AAEf,kBAAM,2CAA2C,KAAK,OAAO;AAAA,EAC/D;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAUA,IAAiD,eAA2C;AAC1F,QAAI,iBAAoD,iBAAiB,KAAK,QAAQ;AAEtF,QAAI,CAAC,gBAAgB;AACnB,YAAM,IAAI;AAAA,QACR;AAAA,MACF;AAAA,IACF;AAKA,UAAM,mBAAmB,KAAK,iBAAiB,cAAc;AAC7D,QAAI,kBAAkB;AACpB,oBAAM,0CAA0C,cAAc;AAC9D,aAAO;AAAA,IACT;AAEA,UAAM,kBAAkB,KAAK,QAAQ,KAAK,cAAc;AAMxD,kBAAM,4CAA4C,cAAc;AAChE,UAAM,aAAa,IAAI,WAAW,eAAe;AACjD,SAAK,iBAAiB,cAAc,IAAI;AAExC,WAAO;AAAA,EACT;AAAA,EAEA,qBAAsC;AACpC,WAAO,KAAK,IAAI,EAAE,mBAAmB;AAAA,EACvC;AAAA,EAIA,QACE,SACA,oBACA,SACY;AACZ,QAAI;AACJ,QAAI;AAEJ,QAAI,OAAO,uBAAuB,YAAY,uBAAuB,MAAM;AACzE,kBAAY,mBAAmB;AAC/B,sBAAgB,mBAAmB;AAAA,IACrC,OAAO;AACL,kBAAY;AACZ,sBAAgB;AAAA,IAClB;AAEA,WAAO,KAAK,IAAI,EAAE,QAAQ,SAAS,WAAW,aAAa;AAAA,EAC7D;AAAA,EAEA,QAAuB,OAAe,SAA4B;AAChE,WAAO,KAAK,IAAI,EAAE,QAAQ,OAAO,OAAO;AAAA,EAC1C;AAAA,EAEA,WAAW,SAAc,SAAyB;AAChD,WAAO,KAAK,IAAI,EAAE,WAAW,SAAS,OAAO;AAAA,EAC/C;AAAA,EAEA,aAAa,SAAc,SAA2B;AACpD,WAAO,KAAK,IAAI,EAAE,aAAa,SAAS,OAAO;AAAA,EACjD;AACF;","names":[]}